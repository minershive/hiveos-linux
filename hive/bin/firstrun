#!/usr/bin/env bash
#Checks if config exists, ask for rig if no config found

[ -t 1 ] && . colors

if [[ -e /hive-config/branding-logo.txt ]]; then
	BRANDING_LOGO=$(cat /hive-config/branding-logo.txt; echo .) #echo . to preserve new lines
	BRANDING_LOGO=${BRANDING_LOGO%.} #remove last .
else
	BRANDING_LOGO="
_______ _______ ___ ___ _______
|   |   |_     _|   |   |    ___|
|       |_|   |_|   |   |    ___|
|___|___|_______|\_____/|_______|

"
fi
BRANDING_LOGO="${BYELLOW}${BRANDING_LOGO}${NOCOLOR}"


#${CYAN}Welcome to Miners Hive.${NOCOLOR}


HELLO_OK="/tmp/.hive-hello-ok"
RIG_CONF="/hive-config/rig.conf"
NVIDIA_OC_CONF="/hive-config/nvidia-oc.conf"
AMD_OC_CONF="/hive-config/amd-oc.conf"
PSW_CHANGE_OK="/hive-config/.psw-change-ok"
mkdir -p "/hive-config"

function psw_change {
if [[ -f $RIG_CONF ]]; then
	source $RIG_CONF
	if [[ -z $RIG_PASSWD ]]; then
		[[ -f $PSW_CHANGE_OK ]] && rm $PSW_CHANGE_OK
		return 1
	fi
else
	[[ -f $PSW_CHANGE_OK ]] && rm $PSW_CHANGE_OK
	return 1
fi
echo -e "$RIG_PASSWD\n$RIG_PASSWD\n" | passwd user > /dev/null 2>&1
sed -i "1s/.*/${RIG_PASSWD}/" /hive-config/vnc-password.txt
[[ -f $PSW_CHANGE_OK ]] && rm $PSW_CHANGE_OK
touch $PSW_CHANGE_OK
echo -e "\n${CYAN}Passwords for SSH and VNC logins are set same as password of RIG in WEB${NOCOLOR}" 
return 0
}


[[ $1 == "-f" ]] && echo "Forcing reconfig"



#Get preconfigured api host
[[ -e /hive-config/rig-config-example.txt ]] &&
	eval `cat /hive-config/rig-config-example.txt | dos2unix | grep '^HIVE_HOST_URL='`
[[ -z $HIVE_HOST_URL ]] && HIVE_HOST_URL='https://api.hiveos.farm'



if [[ ! -f $RIG_CONF ]] || [[ $1 == "-f" ]]; then
	selfupgrade
	msg=$(cat <<EOF
${BRANDING_LOGO}
${CYAN}This is your first boot, no config found at "$RIG_CONF".
Please add your rig in your profile on the web, set the name and password for it.
Then get rig id and give it to me.

${NOCOLOR}
EOF
)
	echo -e "$msg"
elif [[ ! -f $HELLO_OK ]]; then
	msg=$(cat <<EOF
${BRANDING_LOGO}
${YELLOW}Config "$RIG_CONF" exists but during boot the connection to hive server failed.
Either the server or your network is temporary down.
If you have changed the password for this rig, then you need to enter credentials again.$NOCOLOR
Run ${CYAN}hello${NOCOLOR} to try again. Or run ${CYAN}firstrun -f${NOCOLOR} to enter new ID and password.
$NOCOLOR
EOF
)
	echo -e "$msg"

	sleep 5

	echo "Trying to say hello again...";
	hello
	[[ ! -f $PSW_CHANGE_OK ]] && psw_change
	exit 0

else
	[[ ! -f $PSW_CHANGE_OK ]] && psw_change
	exit 0
fi







url=
id=
passwd=



read_url () {
	while true; do
		read url
		[[ -z $url ]] && break
		[[ $url =~ ^(http|https)://.+$ ]] &&
			HIVE_HOST_URL=$url &&
			echo -e "New server URL: ${YELLOW}$HIVE_HOST_URL${NOCOLOR}" &&
			break
		echo "Invalid URL"
	done
}


read_id () {
	while true; do
		echo -n "RIG ID: "
		read id
		[[ $id =~ ^[0-9]+$ ]] && break
		echo "Invalid input"
	done
}

read_passwd () {
	while true; do
		echo -n "Password: "
		read passwd
		#any chars no spaces
		#[[ ! $passwd =~ [[:blank:]] ]] && break
		[[ ! $passwd =~ \"|\'|[[:blank:]] ]] && break #if does not match \" or \' space - break cycle
		echo "Invalid input"
	done
}



while true; do
	echo -e "Server URL: ${YELLOW}$HIVE_HOST_URL${NOCOLOR}"
	echo "Press ENTER to continue with this URL or type a new one"
	read_url
	read_id
	read_passwd

	cat > $RIG_CONF <<FILEEOF
HIVE_HOST_URL="$HIVE_HOST_URL"
RIG_ID="$id"
RIG_PASSWD="$passwd"
FILEEOF

	echo ""
	echo "Config written to \"$RIG_CONF\"."

	#try to connect
	hello restartminer

	if [ $? -eq 0 ]; then
		#miner restart

		#Apply OC if configs are available
		[[ -f $AMD_OC_CONF ]] && amd-oc-safe
		[[ -f $NVIDIA_OC_CONF ]] && nvidia-oc-log
		psw_change
	 	echo -e "\n${BGREEN}Login OK. Happy mining!${NOCOLOR}\n"
	 	exit 0
	fi

	echo -e "${RED}Sorry, id and password did not work, check and try again${NOCOLOR}\n"
done



